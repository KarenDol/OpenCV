<video id="video" width="640" height="480" autoplay style="transform: scaleX(-1); position: absolute; top: 0; left: 0;"></video>
<canvas id="overlay" style="position: absolute; top: 0; left: 0;"></canvas>

{% load static %}
<script src="{% static 'face-api.js/dist/face-api.min.js' %}"></script>
<script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('overlay');

  // Access the camera
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(function(stream) {
      video.srcObject = stream;
    })
    .catch(function(err) {
      console.error("Error accessing the camera: ", err);
    });

  // Load the models required for face detection
  Promise.all([
    faceapi.nets.tinyFaceDetector.loadFromUri('{% static "face-api.js/weights" %}')
  ]).then(startVideo);

  function startVideo() {
    video.addEventListener('play', () => {
      canvas.width = video.width;
      canvas.height = video.height;
      const displaySize = { width: video.width, height: video.height };
      faceapi.matchDimensions(canvas, displaySize);

      setInterval(async () => {
        const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions());
        const resizedDetections = faceapi.resizeResults(detections, displaySize);
        const context = canvas.getContext('2d');

        context.clearRect(0, 0, canvas.width, canvas.height);
        context.setTransform(-1, 0, 0, 1, canvas.width, 0);  // Mirroring canvas horizontally
        faceapi.draw.drawDetections(canvas, resizedDetections);

        // Check if two or more faces are detected
        if (resizedDetections.length > 1) {
          console.log('Multiple faces detected');
        } else {
          console.log('There is only one face');
        }
      }, 100);
    });
  }
</script>
